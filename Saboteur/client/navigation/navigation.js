Accounts.ui.config({
    passwordSignupFields: 'USERNAME_ONLY'
});
AVATAR = "data:image/jpeg;base64,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";


Template.navigation.helpers({
   'usuarios': function() {
        a=[];
        for(i=0;i<Meteor.users.find({},{sort:{"status.online":-1,username:1}}).fetch().length;i++){
            if(Perfiles.findOne({_id:Meteor.users.find().fetch()[i]._id}))
                a.push({username:Meteor.users.find({},{sort:{"status.online":-1,username:1}}).fetch()[i].username,image:Meteor.users.find({},{sort:{"status.online":-1,username:1}}).fetch()[i].profile.image,id:Meteor.users.find({},{sort:{"status.online":-1,username:1}}).fetch()[i]._id,status:Meteor.users.find({},{sort:{"status.online":-1,username:1}}).fetch()[i].status.online})
                //{login:Meteor.users.find().fetch()[i].profile.login})}
        }
        
        return a;
    },
    'tienePerfil':function(){
        if(Perfiles.findOne({_id:Meteor.user()._id})){
            return true;
        }else{
            return false;
        }
    }


});

Template.navigation.events({
	'submit form': function(event) {
            event.preventDefault();
            var buscado = $(event.target).find('[name=busqueda]').val();
            console.log(buscado);
            console.log(Perfiles.findOne({nick: buscado}));
            if(Perfiles.findOne({nick: buscado})){
            	console.log("encontado");
                idRuta=Perfiles.findOne({nick: buscado})._id;
                console.log(idRuta);
                ruta="/perfiles/"+String(idRuta);
                Router.go(ruta);
                //location.href=ruta;
                //.setTimeout(location.reload(),300000);

            }else{
            	console.log("no encontrado");
                $.growlUI('Lo sentimos, usuario no encontrado'); 
            }
     },
     'click #navPerfil':function(){
        
        
        if(!Perfiles.findOne({_id:Meteor.userId()})){
            $.growlUI('Ya tienes tu perfil'); 
            Meteor.users.update({_id:Meteor.userId()},{$set:{profile:{image:AVATAR,login:true}}});
           
            //Se crea el perfil por primera vez
            usuario = Meteor.user().username;
             id = Meteor.user()._id;
            var post = {
                _id:id,
                nick : usuario,
                email : "",
                nombre: "",
                nacionalidad:"",
                genero:""
            }
            //console.log(post);
            Meteor.call("addPerfil", post);
            $.growlUI('Â¡Enhorabuena!', 'Has creado tu perfil'); 
        }
     },  

     'click #login-buttons-logout':function(){
        Router.go('home');
     }
        

            
           
});
/*Deps.autorun(function(){
            for(i=0;i<Meteor.users.find().fetch().length;i++){
                if(Meteor.users.find().fetch()[i].profile.login ===true){
                     Meteor.users.update({_id:Meteor.users.find().fetch()[i]._id},{$set:{profile:{image:Meteor.user().profile.image,login:true}}});
                }else{
                    Meteor.users.update({_id:Meteor.users.find().fetch()[i]._id},{$set:{profile:{image:Meteor.user().profile.image,login:false}}});
                }
            }    
        });*/
